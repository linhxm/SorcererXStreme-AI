<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SorcererXStreme AI Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .json-editor { font-family: monospace; min-height: 400px; }
        /* Style tùy chỉnh cho nội dung Markdown từ AI */
        #markdown-content {
            line-height: 1.7;
            color: #374151;
        }
        #markdown-content p {
            margin-bottom: 1.25rem;
        }
        #markdown-content strong {
            color: #1e1b4b;
            font-weight: 700;
        }
        #markdown-content ul, #markdown-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }
        #markdown-content li {
            margin-bottom: 0.5rem;
        }
        #markdown-content em {
            font-style: italic;
            color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-indigo-700">SorcererXStreme Local Tester</h1>
            <div class="flex items-center gap-4">
                <label for="endpoint" class="font-medium">Endpoint:</label>
                <select id="endpoint" class="border rounded-lg px-3 py-2 bg-white shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="chatbot">Chatbot Lambda</option>
                    <option value="metaphysical">Metaphysical Lambda</option>
                </select>
            </div>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    <span>Input Payload (JSON)</span>
                </h2>
                <textarea id="payload" class="w-full border p-4 rounded-lg json-editor text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-200 outline-none transition-all"></textarea>
                <button onclick="sendRequest()" id="btnSend" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transform active:scale-95 transition-all">
                    GỬI REQUEST
                </button>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col">
                <h2 class="text-xl font-semibold mb-4">AI Response</h2>
                
                <div id="loading" class="hidden flex justify-center items-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-700"></div>
                </div>

                <div id="response-render" class="bg-indigo-50 p-6 rounded-lg border border-indigo-100 min-h-[200px] overflow-auto">
                    <div id="markdown-content" class="text-gray-400 italic">Kết quả sẽ hiển thị tại đây...</div>
                </div>

                <details class="mt-4">
                    <summary class="text-xs text-gray-500 cursor-pointer hover:underline">Xem JSON thô</summary>
                    <pre id="response-raw" class="mt-2 p-4 bg-gray-900 text-green-400 text-xs rounded-lg overflow-auto max-h-40"></pre>
                </details>
            </div>
        </div>
    </div>

    <script>
        const endpointSelect = document.getElementById('endpoint');
        const payloadArea = document.getElementById('payload');
        const renderDiv = document.getElementById('markdown-content');
        const rawPre = document.getElementById('response-raw');
        const loading = document.getElementById('loading');

        // Payload mặc định
        const defaultPayloads = {
            chatbot: {
                "user_context": {
                    "name": "Đại Ca",
                    "gender": "Nam",
                    "birth_date": "15/01/1995"
                },
                "data": {
                    "sessionId": "test-session-123",
                    "question": "Chào nha, đại ca! Hôm nay có gì vui không mậy?"
                }
            },
            metaphysical: {
                "data": {
                    "type": "numerology",
                    "name": "Nguyễn Văn A",
                    "birthDate": "15/01/1995",
                    "gender": "Nam"
                }
            }
        };

        // Khởi tạo payload ban đầu
        payloadArea.value = JSON.stringify(defaultPayloads[endpointSelect.value], null, 4);

        // Đổi payload khi đổi endpoint
        endpointSelect.addEventListener('change', (e) => {
            payloadArea.value = JSON.stringify(defaultPayloads[e.target.value], null, 4);
        });

        async function sendRequest() {
            const endpoint = endpointSelect.value;
            const payload = payloadArea.value;
            
            // Reset hiển thị và hiện loading
            renderDiv.innerHTML = "Đang xử lý...";
            renderDiv.classList.add('italic', 'text-gray-400');
            rawPre.innerText = "";
            loading.classList.remove('hidden');

            try {
                const response = await fetch(`http://127.0.0.1:5000/test/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: payload
                });
                
                const data = await response.json();
                
                let finalResult = data;
                if (data.body && typeof data.body === 'string') {
                    try { finalResult = JSON.parse(data.body); } catch(e) {}
                }

                // Hiển thị JSON thô để debug
                rawPre.innerText = JSON.stringify(finalResult, null, 4);

                // XÓA STYLE CHỜ (italic) TRƯỚC KHI HIỂN THỊ KẾT QUẢ THẬT
                renderDiv.classList.remove('italic', 'text-gray-400');
                renderDiv.classList.add('text-gray-800');

                // HIỂN THỊ RENDERED MARKDOWN
                if (finalResult.reply) {
                    marked.setOptions({ gfm: true, breaks: true });
                    renderDiv.innerHTML = marked.parse(finalResult.reply);
                } else if (finalResult.interpretation) {
                    renderDiv.innerHTML = marked.parse(finalResult.interpretation);
                } else {
                    renderDiv.innerHTML = "<span class='text-red-500'>Không tìm thấy nội dung trả về.</span>";
                }

            } catch (error) {
                renderDiv.classList.remove('italic', 'text-gray-400');
                renderDiv.innerHTML = `<span class="text-red-600 font-bold">Lỗi kết nối: ${error.message}</span>`;
            } finally {
                loading.classList.add('hidden');
            }
        }
    </script>
</body>
</html>