<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>SorcererXStreme AI - Feature-Specific Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code&display=swap');
        .json-editor { font-family: 'Fira Code', monospace; font-size: 13px; }
        .prose pre { background: #1a1a1a; padding: 1rem; border-radius: 0.5rem; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 p-4">
    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 bg-slate-800 p-4 rounded-xl border border-slate-700 gap-4">
            <h1 class="text-2xl font-bold text-indigo-400 flex items-center">
                <span class="mr-2">üîÆ</span> SorcererXStreme Tester
            </h1>
            <div class="flex gap-4 items-center">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">Ch·ªçn Ch·∫ø ƒë·ªô Test:</label>
                <select id="mode-select" class="bg-slate-700 border-none rounded px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none cursor-pointer">
                    <option value="metaphysical">üéØ Lu·∫≠n Gi·∫£i S√¢u (Deep-dive)</option>
                    <option value="chatbot">üí¨ Chatbot (Conversational)</option>
                </select>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-3 space-y-4">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg overflow-y-auto max-h-[80vh]">
                    <h2 class="text-sm font-bold text-slate-500 uppercase mb-4 border-b border-slate-700 pb-2">T√≠nh nƒÉng chi ti·∫øt</h2>
                    <div id="preset-buttons" class="flex flex-col gap-2">
                        </div>
                </div>
            </div>

            <div class="lg:col-span-9 space-y-6">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-2xl">
                    <div class="flex justify-between items-center mb-2">
                        <label id="current-feature-label" class="text-xs font-bold text-indigo-400 uppercase">Payload Editor</label>
                        <span id="badge" class="text-[10px] px-2 py-0.5 rounded bg-indigo-500/20 text-indigo-400 font-mono tracking-tighter">READY</span>
                    </div>
                    <textarea id="payload-input" class="json-editor w-full bg-slate-900 border border-slate-700 rounded p-4 text-emerald-400 h-64 focus:outline-none focus:border-indigo-500 shadow-inner" spellcheck="false"></textarea>
                    <button id="send-btn" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-500 py-4 rounded-lg font-bold shadow-lg transition-all active:scale-[0.98]">G·ª¨I Y√äU C·∫¶U ƒê·∫æN SERVER</button>
                </div>

                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 min-h-[400px] shadow-xl relative">
                    <h3 class="text-xl font-bold mb-4 text-indigo-300 flex items-center">
                        <span class="mr-2">‚ú®</span> K·∫øt qu·∫£ lu·∫≠n gi·∫£i
                    </h3>

                    <div id="summary-cont" class="hidden mb-6 grid grid-cols-2 md:grid-cols-4 gap-3 animate-fade-in"></div>

                    <div id="usage-info" class="mb-4 flex gap-4 text-[10px] font-mono text-slate-500 border-b border-slate-700/50 pb-2"></div>
                    
                    <div id="ai-output" class="prose prose-invert max-w-none text-slate-300 leading-relaxed">
                        Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y ch·ªçn m·ªôt feature-type b√™n tr√°i v√† nh·∫•n g·ª≠i...
                    </div>

                    <details class="mt-8 border-t border-slate-700 pt-4">
                        <summary class="text-xs text-slate-500 cursor-pointer uppercase hover:text-indigo-400 transition-colors">JSON Debugger</summary>
                        <pre id="json-output" class="text-[11px] mt-2 max-h-64 overflow-auto"></pre>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <script>
        const modeSelect = document.getElementById('mode-select');
        const payloadInput = document.getElementById('payload-input');
        const presetContainer = document.getElementById('preset-buttons');
        const summaryCont = document.getElementById('summary-cont');

        // DANH S√ÅCH PAYLOAD CHI TI·∫æT T·ª™NG FEATURE TYPE
        const payloads = {
            metaphysical: {
                "üÉè Tarot: H·ªèi ƒë√°p (1 l√°)": { "domain": "tarot", "feature_type": "question", "data": { "cards_drawn": [{"card_name": "The Sun", "is_upright": true, "position": "present"}], "question": "H√¥m nay c√≥ tin vui v·ªÅ ti·ªÅn b·∫°c kh√¥ng?" }, "user_context": { "name": "ƒê·∫°i ca", "gender": "male" } },
                "üÉè Tarot: Tr·∫£i b√†i (3 l√°)": { "domain": "tarot", "feature_type": "overview", "data": { "cards_drawn": [{"card_name": "The Fool", "is_upright": true, "position": "past"}, {"card_name": "The Tower", "is_upright": false, "position": "present"}, {"card_name": "The World", "is_upright": true, "position": "future"}], "question": "S·ª± nghi·ªáp c·ªßa t√¥i trong 3 th√°ng t·ªõi." }, "user_context": { "name": "ƒê·∫°i ca", "gender": "male" } },
                "üåü Astro: T·ªïng quan cung": { "domain": "astrology", "feature_type": "overview", "user_context": { "name": "H·ªìng", "birth_date": "20/10/1990", "gender": "female" } },
                "üåü Astro: H·ª£p ƒë√¥i l·ª©a": { "domain": "astrology", "feature_type": "love", "user_context": { "birth_date": "20/10/1990", "gender": "female" }, "partner_context": { "birth_date": "05/02/1988" } },
                "üî¢ Th·∫ßn s·ªë: S·ªë ch·ªß ƒë·∫°o": { "domain": "numerology", "user_context": { "birth_date": "12/12/1995", "gender": "male" } },
                "üìú T·ª≠ vi: L·∫≠p l√° s·ªë": { "domain": "horoscope", "user_context": { "name": "VƒÉn Linh", "birth_date": "15/05/1992", "birth_time": "08:30", "gender": "male" } }
            },
            chatbot: {
                "üí¨ Chat: Nh√¢y/Vibe Nam": { "user_context": { "name": "Th·∫ø Anh", "gender": "Nam", "birth_date": "15/01/1995" }, "data": { "sessionId": "session-dev-001", "question": "Ch√†o nha m·∫≠y, ƒë·∫°i ca VƒÉn Linh ƒë√¢u r·ªìi?" } },
                "üí¨ Chat: T√¢m t√¨nh N·ªØ": { "user_context": { "name": "Ch·ªã ƒë·∫πp", "gender": "N·ªØ", "birth_date": "20/10/1990" }, "data": { "sessionId": "session-dev-002", "question": "M√¨nh ƒëang th·∫•y kh√° √°p l·ª±c, b·∫°n cho l·ªùi khuy√™n nh√©." } },
                "üí¨ Chat: H·ªèi huy·ªÅn h·ªçc": { "user_context": { "name": "·∫®n danh", "gender": "Kh√°c" }, "data": { "sessionId": "session-dev-003", "question": "L√° b√†i The Moon trong Tarot c√≥ √Ω nghƒ©a g√¨ khi h·ªèi v·ªÅ s·ª± l·ª´a d·ªëi?" } }
            }
        };

        function updatePresets() {
            const mode = modeSelect.value;
            presetContainer.innerHTML = '';
            
            Object.keys(payloads[mode]).forEach(key => {
                const btn = document.createElement('button');
                btn.className = "bg-slate-700 hover:bg-indigo-600 p-3 rounded text-[11px] text-left transition-all border border-slate-600 hover:border-indigo-400 font-medium group flex justify-between items-center";
                btn.innerHTML = `<span>${key}</span> <span class="opacity-0 group-hover:opacity-100 transition">‚Üí</span>`;
                
                btn.onclick = () => {
                    payloadInput.value = JSON.stringify(payloads[mode][key], null, 4);
                    document.getElementById('badge').innerText = mode.toUpperCase();
                    document.getElementById('current-feature-label').innerText = key;
                };
                presetContainer.appendChild(btn);
            });

            // Load payload ƒë·∫ßu ti√™n m·∫∑c ƒë·ªãnh
            const firstKey = Object.keys(payloads[mode])[0];
            payloadInput.value = JSON.stringify(payloads[mode][firstKey], null, 4);
            document.getElementById('badge').innerText = mode.toUpperCase();
            document.getElementById('current-feature-label').innerText = firstKey;
        }

        modeSelect.onchange = updatePresets;
        updatePresets();

        document.getElementById('send-btn').onclick = async () => {
            const output = document.getElementById('ai-output');
            const jsonOut = document.getElementById('json-output');
            const usageOut = document.getElementById('usage-info');
            const mode = modeSelect.value;
            
            output.innerHTML = "<div class='flex items-center text-indigo-400'><svg class='animate-spin h-5 w-5 mr-3 border-2 border-indigo-500 border-t-transparent rounded-full' viewBox='0 0 24 24'></svg> üîÆ ƒêang gi·∫£i m√£ nƒÉng l∆∞·ª£ng...</div>";
            summaryCont.classList.add('hidden');
            summaryCont.innerHTML = '';
            
            try {
                const response = await fetch(`http://127.0.0.1:5000/test/${mode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: payloadInput.value
                });
                
                const data = await response.json();
                jsonOut.innerText = JSON.stringify(data, null, 4);

                let result = data;
                if (data.body) result = typeof data.body === 'string' ? JSON.parse(data.body) : data.body;

                // X·ª¨ L√ù K·∫æT QU·∫¢ ƒê·ªÇ KH√îNG B·ªä L·ªñI MARKED([OBJECT OBJECT])
                let textToParse = "";
                
                if (result.reply) {
                    // C·∫•u tr√∫c c·ªßa Chatbot
                    textToParse = result.reply;
                } else if (result.answer) {
                    // C·∫•u tr√∫c c·ªßa Metaphysical
                    if (typeof result.answer === 'object' && result.answer !== null) {
                        // Tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát: T·ª≠ Vi (Horoscope)
                        textToParse = result.answer.analysis || "";
                        
                        if (result.answer.summary) {
                            summaryCont.classList.remove('hidden');
                            const s = result.answer.summary;
                            const items = [
                                { l: "Can Chi", v: s.can_chi },
                                { l: "B·∫£n M·ªánh", v: s.ban_menh || s.menh },
                                { l: "C·ª•c", v: s.cuc },
                                { l: "M·ªánh Ch·ªß", v: s.menh_chu }
                            ];
                            summaryCont.innerHTML = items.filter(i => i.v).map(i => `
                                <div class="bg-slate-700/50 p-2 rounded border border-slate-600 shadow-sm">
                                    <p class="text-[9px] text-slate-500 uppercase font-black">${i.l}</p>
                                    <p class="text-xs text-indigo-300 font-bold">${i.v}</p>
                                </div>
                            `).join('');
                        }
                    } else {
                        // Tarot, Th·∫ßn s·ªë, Chi√™m tinh (d·∫°ng String)
                        textToParse = result.answer;
                    }
                }

                // X·ª¨ L√ù HI·ªÇN TH·ªä TOKEN
                const usage = result.usage || {};
                const inTok = usage.inputTokens || usage.input_tokens || 0;
                const outTok = usage.outputTokens || usage.output_tokens || 0;

                if (inTok > 0 || outTok > 0) {
                    usageOut.innerHTML = `<span>üì• Input: <b>${inTok}</b></span> <span>üì§ Output: <b>${outTok}</b></span>`;
                } else { usageOut.innerText = ""; }

                // RENDER
                output.innerHTML = marked.parse(String(textToParse || "V≈© tr·ª• kh√¥ng c√≥ ph·∫£n h·ªìi."));

            } catch (e) {
                output.innerHTML = `<div class="bg-red-900/20 border border-red-500/50 p-4 rounded text-red-400">‚ùå <b>L·ªói:</b> ${e.message}</div>`;
            }
        };
    </script>
</body>
</html>